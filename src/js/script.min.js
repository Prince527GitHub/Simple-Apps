const{DownloaderHelper:DownloaderHelper}=require("node-downloader-helper"),{ipcRenderer:ipcRenderer}=require("electron"),fs=require("fs");function isValidHttpUrl(string){let url;try{url=new URL(string)}catch(_){return!1}return"http:"===url.protocol||"https:"===url.protocol}async function mainMenu(){const url=document.getElementById("basic-url").value;if(url.length>0&&!isValidHttpUrl(url))alert("Invalid URL");else if(document.getElementById("body").innerHTML=`<label for="basic-url" class="form-label">Downloader</label><div class="input-group mb-3"><button class="btn btn-secondary" type="button" id="button-addon1" onclick="downloadFolder('set')"><i class="bi bi-folder"></i></button><input type="text" class="form-control" id="basic-url" aria-describedby="basic-addon3" placeholder="URL" value="${url}"><button class="btn btn-secondary" type="button" id="button-addon2" onclick="addDownload()"><i class="bi bi-download"></i></button></div>`,await hasData("folder",`${process.env.APPDATA}/downloader/settings`)){const folder=await getData("folder",`${process.env.APPDATA}/downloader/settings`);document.getElementById("button-addon1").innerHTML="",document.getElementById("button-addon1").innerHTML='<i class="bi bi-folder-check"></i>'}}async function addDownload(){const url=document.getElementById("basic-url").value;if(!isValidHttpUrl(url))return void alert("Invalid URL");document.getElementById("body").innerHTML+="";const path=await downloadFolder("get");console.log(path);const dl=new DownloaderHelper(url,String(path));dl.on("end",()=>{resetHTML()}),dl.on("error",()=>{resetHTML()}),dl.on("progress",progress=>{console.log(progress);const percent=String(progress.progress).split(".")[0];document.getElementById("download-bar").innerHTML=`${percent}%`,document.getElementById("download-bar").style.width=`${percent}%`}),dl.on("start",()=>{document.getElementById("body").innerHTML='<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div><div class="progress"><div id="download-bar" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">0</div></div>'}),dl.start()}async function downloadFolder(type){if("set"===type){const folder=await ipcRenderer.invoke("open-folder-dialog");return null===folder?mainMenu():(await setData("folder",`${process.env.APPDATA}/downloader/settings`,JSON.stringify({path:String(folder)})),mainMenu())}if("get"===type){if(await hasData("folder",`${process.env.APPDATA}/downloader/settings`)){const data=JSON.parse(await getData("folder",`${process.env.APPDATA}/downloader/settings`)).path;return fs.existsSync(data)?data:(await removeData("folder",`${process.env.APPDATA}/downloader/settings`),resetHTML())}return resetHTML()}}async function getData(id,path){if(fs.existsSync(`${path}/${id}.json`))return JSON.parse(fs.readFileSync(`${path}/${id}.json`,"utf8"))}async function setData(id,path,data){if(fs.existsSync(path)||await fs.mkdirSync(path,{recursive:!0}),fs.existsSync(path))return fs.writeFileSync(`${path}/${id}.json`,JSON.stringify(data))}async function hasData(id,path){return fs.existsSync(`${path}/${id}.json`)}async function removeData(id,path){if(fs.existsSync(`${path}/${id}.json`))return fs.unlinkSync(`${path}/${id}.json`)}async function resetHTML(){if(document.getElementById("body").innerHTML='<label for="basic-url" class="form-label">Downloader</label><div class="input-group mb-3"><button class="btn btn-secondary" type="button" id="button-addon1" onclick="downloadFolder(\'set\')"><i class="bi bi-folder"></i></button><input type="text" class="form-control" id="basic-url" aria-describedby="basic-addon3" placeholder="URL"><button class="btn btn-secondary" type="button" id="button-addon2" onclick="addDownload()"><i class="bi bi-download"></i></button></div>',await hasData("folder",`${process.env.APPDATA}/downloader/settings`)){const folder=await getData("folder",`${process.env.APPDATA}/downloader/settings`);document.getElementById("button-addon1").innerHTML="",document.getElementById("button-addon1").innerHTML='<i class="bi bi-folder-check"></i>'}}resetHTML();